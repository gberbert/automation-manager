# Agent Memory RAG

## Histórico de Alterações

### [2025-12-28T09:50:00-03:00] - Correção de Contagem de Caracteres e Limpeza de Conteúdo
**O que foi feito:**
- Atualização em `Approvals.jsx`:
  - `safeContent`: Adicionada lógica de "sanitização" para remover artefatos JSON e chaves `imagePrompt` que vazaram para o campo de conteúdo.
  - `handleApprove`: Modificado para salvar a versão limpa (`cleanBody`) no Firestore ao aprovar.
- Atualização em `server/utils/gemini.js`:
  - Melhoria nas funções `forceCleanText` e `robustParse` para detectar e remover vazamentos de `imagePrompt` de forma mais agressiva.

**Motivo:**
- O usuário reportou que a contagem de caracteres estava incorreta (muito alta), indicando que metadados ou prompts estavam sendo contados junto com o texto do post.
- Isso ocorria devido a falhas no parsing da resposta da IA, onde chaves JSON vazavam para a string de conteúdo.
- A correção garante que o usuário veja apenas o texto limpo, que a contagem reflita apenas o que será publicado, e que a publicação real seja higienizada.

**Snapshot de Segurança (Código Deprecated):**
*Approvals.jsx (Antigo safeContent):*
```javascript
const safeContent = (content) => {
    if (!content) return '';
    if (typeof content === 'string') return content;
    if (typeof content === 'object') return content.body || content.text || content.headline || JSON.stringify(content);
    return String(content);
};
```

### [2025-12-31T12:40:00-03:00] - Restauração de Dependências e Ambiente
**O que foi feito:**
- Execução do script `npm run install:all` para instalar dependências na raiz, `./client` e `./server`.

**Motivo:**
- O ambiente estava inconsistente, apresentando erros de `MODULE_NOT_FOUND` (express) e binário não encontrado (vite) ao tentar iniciar via `npm run dev`.

**Snapshot de Segurança (N/A):**
- Ação corretiva de infraestrutura, sem alteração de código fonte.

### [2025-12-31T12:45:00-03:00] - Fix White Screen e Desativação PWA Dev
**O que foi feito:**
- Alterado `client/vite.config.js`: `devOptions.enabled` definido como `false`.

**Motivo:**
- O navegador estava servindo uma versão em cache (Service Worker) procurando por `main.tsx` (inexistente), enquanto o arquivo real é `main.jsx`.
- A desativação evita conflitos de cache e erros de sintaxe (`import outside module`) durante o desenvolvimento.

**Snapshot de Segurança (Código Anterior):**
File `client/vite.config.js`:
```javascript
      devOptions: {
        enabled: true,
        type: 'module',
      },
```

### [2026-01-28T14:55:00-03:00] - Correção Loop OAuth LinkedIn e Documentação
**O que foi feito:**
- Atualização em `server/utils/linkedin.js`:
  - Implementada função `exchangeToken` para troca segura de Authorization Code por Access Token via backend.
- Atualização em `server/index.js`:
  - Criada rota `/auth/linkedin/callback` para interceptar o redirect do LinkedIn.
  - Lógica de persistência automática do token no Firestore (`settings/global`).
  - Página de sucesso HTML simples para fechar o popup automaticamente.
- Atualização em `.stack_tech.md`:
  - Adicionado `@supabase/supabase-js`.
  - Inclusão das páginas `Repost.jsx`, `Published.jsx`, `Login.jsx` na documentação.

**Motivo:**
- O fluxo de autenticação estava quebrado ("Tela Branca") pois o redirect do LinkedIn apontava para uma rota inexistente no backend, e o frontend não conseguia processar o código puramente via client-side sem expor secrets ou devido a bloqueios de CORs/Redirecionamento incorreto entre Localhost e Produção.
- A documentação estava defasada em relação ao código real.

**Snapshot de Segurança (Código Deprecated):**
*N/A - Funcionalidade nova adicionada (Rota Callback) e ajuste de parâmetros.*
### [2026-02-02T16:45:00-03:00] - AI Assistant & Reply Generator
**O que foi feito:**
- **Frontend (`Layout.jsx`, `Repost.jsx`):**
  - Adicionado item de menu "AI Assistant" (aponta para `/repost`).
  - Nova funcionalidade "Responder Comentário" na tela de Repost.
  - UI atualizada para aceitar 2 contextos simultâneos: 
    1. Contexto do Post Original (Texto/Link/Imagem).
    2. Contexto do Comentário Alvo (Texto/Imagem/Print).
- **Backend (`server/index.js`, `server/utils/gemini.js`):**
  - Atualizada rota `/api/generate-reaction` para receber `targetComment` e `targetCommentImage`.
  - Atualizado prompt do Gemini para suportar o modo `reply`, instruindo a IA a responder diretamente ao comentário alvo mantendo a persona.

**Motivo:**
- Necessidade de agilizar a gestão de comunidade, permitindo que o usuário tire um print de um comentário (fã ou hater) e gere uma resposta espirituosa/técnica baseada no contexto do post original, sem digitar tudo manualmente.
