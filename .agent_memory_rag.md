# Agent Memory RAG

## Histórico de Alterações

### [2025-12-28T09:50:00-03:00] - Correção de Contagem de Caracteres e Limpeza de Conteúdo
**O que foi feito:**
- Atualização em `Approvals.jsx`:
  - `safeContent`: Adicionada lógica de "sanitização" para remover artefatos JSON e chaves `imagePrompt` que vazaram para o campo de conteúdo.
  - `handleApprove`: Modificado para salvar a versão limpa (`cleanBody`) no Firestore ao aprovar.
- Atualização em `server/utils/gemini.js`:
  - Melhoria nas funções `forceCleanText` e `robustParse` para detectar e remover vazamentos de `imagePrompt` de forma mais agressiva.

**Motivo:**
- O usuário reportou que a contagem de caracteres estava incorreta (muito alta), indicando que metadados ou prompts estavam sendo contados junto com o texto do post.
- Isso ocorria devido a falhas no parsing da resposta da IA, onde chaves JSON vazavam para a string de conteúdo.
- A correção garante que o usuário veja apenas o texto limpo, que a contagem reflita apenas o que será publicado, e que a publicação real seja higienizada.

**Snapshot de Segurança (Código Deprecated):**
*Approvals.jsx (Antigo safeContent):*
```javascript
const safeContent = (content) => {
    if (!content) return '';
    if (typeof content === 'string') return content;
    if (typeof content === 'object') return content.body || content.text || content.headline || JSON.stringify(content);
    return String(content);
};
```
